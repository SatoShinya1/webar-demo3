<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>ARアニメーション選択 (MindARデバッグ版)</title>

  <!-- 必要最小限（extrasは一旦外す） -->
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>

  <style>
    html, body { margin:0; padding:0; height:100%; width:100%; overflow:hidden; font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";}
    #menu, #ar { height:100%; width:100%; }
    #menu { display:flex; align-items:center; justify-content:center; flex-direction:column; gap:12px; background:#f5f5f5; }
    #ar   { visibility:hidden; position:relative; background:#000; }
    #ar.show { visibility:visible; }

    a-scene[embedded], .a-canvas {
      position:absolute !important; inset:0 !important;
      width:100% !important; height:100% !important;
    }
    #back { position:absolute; left:50%; transform:translateX(-50%); bottom:16px; z-index:10;
            background:#222; color:#fff; border:none; padding:10px 14px; border-radius:8px; }
    #hint  { color:#666; font-size:14px; }
    #toast { position:fixed; left:50%; transform:translateX(-50%); bottom:20px; background:#111; color:#fff;
             padding:8px 12px; border-radius:8px; font-size:12px; z-index:9999; display:none; }
    #toast.show { display:block; }
  </style>
</head>
<body>
  <div id="menu">
    <h1>ARアニメーションを選択</h1>
    <button data-type="left">左に行く</button>
    <button data-type="right">右に行く</button>
    <button data-type="approach">近づく</button>
    <button data-type="away">遠ざかる</button>
    <div id="hint"></div>
  </div>

  <div id="ar">
    <!-- ここに a-scene を動的に挿入します -->
    <button id="back">メニューに戻る</button>
  </div>

  <div id="toast"></div>

  <script>
    const menu = document.getElementById('menu');
    const ar   = document.getElementById('ar');
    const back = document.getElementById('back');
    const toast = document.getElementById('toast');

    function tip(msg){ console.warn(msg); toast.textContent = msg; toast.classList.add('show'); setTimeout(()=>toast.classList.remove('show'), 3500); }

    // HTTPS / localhost 警告
    (function(){
      const ok = location.protocol === 'https:' || location.hostname === 'localhost' || location.hostname === '127.0.0.1';
      const hint = document.getElementById('hint');
      if (!ok) { hint.textContent = '※ カメラは HTTPS または localhost でのみ動作します。http/fileでは動きません。'; }
    })();

    // クリックで開始
    document.querySelectorAll('#menu button[data-type]').forEach(b=>{
      b.addEventListener('click', ()=> startAR(b.getAttribute('data-type')));
    });
    back.addEventListener('click', showMenu);

    let scene=null, marker=null;

    function buildScene(){
      // 既存破棄
      if (scene?.parentNode) scene.parentNode.removeChild(scene);

      // a-scene
      scene = document.createElement('a-scene');
      scene.setAttribute('embedded', '');
      scene.setAttribute('vr-mode-ui', 'enabled: false');
      scene.setAttribute('device-orientation-permission-ui', 'enabled: false');
      scene.setAttribute('mindar-image', 'imageTargetSrc: ./targets.mind; maxTrack: 1; uiScanning: yes; uiLoading: yes;');

      // assets（GLBを事前ロード）
      const assets = document.createElement('a-assets');
      const glb = document.createElement('a-asset-item');
      glb.setAttribute('id', 'bird');
      glb.setAttribute('src', 'bird3.glb');
      assets.appendChild(glb);
      scene.appendChild(assets);

      // マーカー
      marker = document.createElement('a-entity');
      marker.setAttribute('id', 'marker');
      marker.setAttribute('mindar-image-target', 'targetIndex: 0');
      scene.appendChild(marker);

      // カメラ
      const cam = document.createElement('a-entity');
      cam.setAttribute('camera', '');
      scene.appendChild(cam);

      // イベントログ
      scene.addEventListener('loaded', ()=> console.log('[A-Frame] scene loaded'));
      scene.addEventListener('renderstart', ()=> console.log('[A-Frame] renderstart'));
      scene.addEventListener('arReady', ()=> console.log('[MindAR] arReady'));
      scene.addEventListener('arError', e=> { console.error('[MindAR] arError', e); tip('AR初期化に失敗しました（権限/HTTPS/カメラ使用中等）'); });
      marker.addEventListener('targetFound', ()=> console.log('[MindAR] targetFound'));
      marker.addEventListener('targetLost',  ()=> console.log('[MindAR] targetLost'));

      ar.appendChild(scene);
      return scene;
    }

    function mountModel(type){
      // 既存削除
      marker.querySelector('#current-model')?.remove();

      const m = document.createElement('a-entity');
      m.setAttribute('id', 'current-model');
      m.setAttribute('gltf-model', '#bird');

      switch(type){
        case 'left':
          m.setAttribute('rotation','0 0 90');
          m.setAttribute('scale','3 3 3');
          m.setAttribute('animation','property: position; from: 0 0 0; to: -5 0 0; dur: 4000; loop: true; dir: normal');
          break;
        case 'right':
          m.setAttribute('rotation','0 0 -90');
          m.setAttribute('scale','3 3 3');
          m.setAttribute('animation','property: position; from: 0 0 0; to: 5 0 0; dur: 4000; loop: true; dir: normal');
          break;
        case 'approach':
          m.setAttribute('rotation','0 0 0');
          m.setAttribute('scale','1 1 1');
          m.setAttribute('animation','property: scale; from: 1 1 1; to: 10 10 10; dur: 15000; loop: false');
          break;
        case 'away':
          m.setAttribute('rotation','0 0 180');
          m.setAttribute('scale','10 10 10');
          m.setAttribute('animation','property: scale; from: 10 10 10; to: 1 1 1; dur: 20000; loop: false');
          break;
        default:
          m.setAttribute('scale','3 3 3');
      }
      marker.appendChild(m);
    }

    async function startAR(animationType){
      // 画面切替（visibilityで表示＝display:noneは使わない）
      menu.style.display='none';
      ar.classList.add('show');

      // シーン生成
      buildScene();

      // 重要：ユーザー操作後に start() を明示実行（権限周りを安定化）
      const sys = scene.systems && scene.systems['mindar-image-system'];
      if (!sys) {
        tip('mindar-image-system が見つかりません。CDN/バージョンを確認してください。');
        return;
      }

      // リサイズを2度発火（0×0対策）
      setTimeout(()=> window.dispatchEvent(new Event('resize')), 50);
      setTimeout(()=> window.dispatchEvent(new Event('resize')), 250);

      try {
        // 事前に targets.mind / GLB をフェッチ検査（404/CORS検出）
        await Promise.all([
          fetch('./targets.mind', {method:'HEAD'}).then(r=>{ if(!r.ok) throw new Error('targets.mind '+r.status); }),
          fetch('./bird3.glb',   {method:'HEAD'}).then(r=>{ if(!r.ok) throw new Error('bird3.glb '+r.status); }),
        ]);
      } catch(e) {
        console.error('[Precheck]', e);
        tip('ファイルが見つかりません（targets.mind / bird3.glb の配置とパスを確認）');
        return;
      }

      try {
        await sys.start(); // ← 明示開始
        console.log('[MindAR] start() resolved');
        // A-Frameのloaded/renderstart後にモデル搭載
        const onReady = ()=>{
          mountModel(animationType);
          scene.removeEventListener('renderstart', onReady);
        };
        scene.addEventListener('renderstart', onReady);

        // スピナー監視：10秒経ってターゲット未検出ならヒント
        setTimeout(()=>{
          const vid = document.querySelector('video');
          if (!vid || vid.videoWidth === 0 || vid.videoHeight === 0) {
            tip('カメラ映像が取得できていません（HTTPS/権限/他アプリ使用中を確認）');
          }
        }, 10000);

      } catch(err) {
        console.error('[MindAR] start() failed', err);
        tip('ARの起動に失敗しました（ブラウザ権限/HTTPS/OS設定をご確認ください）');
      }
    }

    function showMenu(){
      // シーン破棄
      if (scene?.parentNode) scene.parentNode.removeChild(scene);
      scene=null; marker=null;

      ar.classList.remove('show');
      menu.style.display='';
    }
  </script>
</body>
</html>
